<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carry Nest</title>
  <style>
    :root { --accent: #ff9800; --green: #25D366; --blue: #007bff; --muted: #666; }
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 14px; }
    .wrap { max-width: 980px; margin: 18px auto; }
    .card { background: #fff; border-radius: 10px; padding: 14px; margin-bottom: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .header { display: flex; align-items: center; gap: 12px; }
    .logo { width: 64px; height: 64px; object-fit: contain; border-radius: 8px; }
    h3 { margin: 6px 0; }
    input, button, select { font-size: 14px; }
    input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; margin-top: 8px; }
    button { padding: 10px 12px; border-radius: 8px; border: none; color: #fff; cursor: pointer; }
    .small { background: #777; padding: 8px 10px; border-radius: 8px; }
    .muted { color: var(--muted); font-size: 13px; }
    .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 12px; }
    .product { border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fafafa; }
    .product img { width: 100%; height: 150px; object-fit: cover; border-radius: 6px; }
    .price { font-weight: 700; }
    .available { color: green; font-weight: 700; }
    .unavailable { color: red; font-weight: 700; }
    .cart-btn { width: 100%; padding: 10px; border-radius: 8px; background: var(--green); font-weight: 700; margin-top: 8px; }
    .wa-btn { background: var(--green); margin-top: 8px; }
    .buy-btn { background: var(--blue); margin-top: 8px; }
    .modal { position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .modal .box { background: #fff; padding: 16px; border-radius: 10px; max-width: 420px; width: 100%; }
    @media (max-width: 480px) { .product img { height: 120px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card header">
      <img src="https://i.ibb.co/JWX4cdyH/1000152655-removebg-preview.png" class="logo" alt="Carry Nest">
      <div>
        <div style="font-weight:800; font-size:20px">Carry Nest</div>
        <div class="muted">Fresh essentials — quick delivery</div>
      </div>
    </div>

    <!-- Auth Card -->
    <div class="card" id="authCard">
      <h3>Account</h3>
      <div id="loginBox">
        <input id="loginMobile" placeholder="Mobile (10 digits)">
        <div style="display:flex; gap:8px; margin-top:8px">
          <button onclick="sendOTP()" style="background: var(--accent)">Send OTP</button>
          <button class="small" onclick="showSignup()">Create</button>
          <button class="small" onclick="showForgot()">Forgot</button>
          <button class="small" onclick="skip()">Skip</button>
        </div>
        <div id="otpArea" style="display:none; margin-top:8px">
          <input id="loginOtp" placeholder="Enter OTP (1234)">
          <div style="display:flex; gap:8px; margin-top:8px">
            <button onclick="verifyOTP()" style="background: var(--accent)">Verify</button>
            <button class="small" onclick="hideOtp()">Cancel</button>
          </div>
        </div>
      </div>
      <div id="signupBox" style="display:none; margin-top: 12px">
        <input id="su_name" placeholder="Your name">
        <input id="su_mobile" placeholder="Mobile (10 digits)">
        <input id="su_pass" type="password" placeholder="Create password">
        <div style="display:flex; gap:8px; margin-top:8px">
          <button onclick="signup()" style="background: var(--accent)">Create</button>
          <button class="small" onclick="showLogin()">Back</button>
        </div>
      </div>
      <div id="forgotBox" style="display:none; margin-top: 12px">
        <input id="fr_mobile" placeholder="Your mobile">
        <div style="display:flex; gap:8px; margin-top:8px">
          <button onclick="sendForgotOTP()" style="background: var(--accent)">Send OTP</button>
          <button class="small" onclick="showLogin()">Back</button>
        </div>
        <div id="forgotOtpArea" style="display:none; margin-top:8px">
          <input id="fr_otp" placeholder="Enter OTP (1234)">
          <input id="fr_new" type="password" placeholder="New password">
          <button onclick="resetPassword()" style="background: var(--accent); margin-top:8px; width:100%">Reset</button>
        </div>
      </div>
      <div style="margin-top:10px" class="muted">
        Support: <a href="mailto:carrynest.india@gmail.com">carrynest.india@gmail.com</a>
      </div>
    </div>

    <!-- Products Card -->
    <div class="card" id="productsCard" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3>Products</h3>
        <div>
          <button class="small" onclick="openCart()">Cart (<span id="cartCount">0</span>)</button>
          <button class="small" onclick="reloadProducts()">Reload</button>
        </div>
      </div>
      <div id="products" class="products"></div>
    </div>

    <!-- Cart Card -->
    <div class="card" id="cartCard" style="display:none">
      <h3>Your Cart</h3>
      <div id="cartItems"></div>
      <h3 id="cartTotal"></h3>
      <div style="display:flex; gap:8px">
        <button class="cart-btn" onclick="checkout()">Checkout on WhatsApp</button>
        <button class="small" onclick="closeCart()">Continue</button>
      </div>
    </div>
  </div>

  <!-- Instant Buy Modal -->
  <div id="modal" class="modal" style="display:none">
    <div class="box">
      <h3 id="modalName"></h3>
      <img id="modalImg" src="" style="width:100%; height:180px; object-fit:cover; border-radius:8px">
      <p id="modalPrice" style="font-weight:700"></p>
      <p id="modalStock"></p>
      <input id="custName" placeholder="Your name">
      <input id="custMobile" placeholder="Your mobile (10 digits)">
      <input id="custQty" type="number" min="1" value="1">
      <div style="display:flex; gap:8px; margin-top:8px">
        <button style="background:#25D366; padding:10px; border-radius:8px; border:none" onclick="placeInstantOrder()">Place on WhatsApp</button>
        <button class="small" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const authCard = document.getElementById('authCard');
    const productsCard = document.getElementById('productsCard');
    const cartCard = document.getElementById('cartCard');
    const productsDiv = document.getElementById('products');
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    const cartCount = document.getElementById('cartCount');
    const loginBox = document.getElementById('loginBox');
    const signupBox = document.getElementById('signupBox');
    const forgotBox = document.getElementById('forgotBox');
    const otpArea = document.getElementById('otpArea');
    const su_name = document.getElementById('su_name');
    const su_mobile = document.getElementById('su_mobile');
    const su_pass = document.getElementById('su_pass');
    const loginMobile = document.getElementById('loginMobile');
    const loginOtp = document.getElementById('loginOtp');
    const fr_mobile = document.getElementById('fr_mobile');
    const fr_otp = document.getElementById('fr_otp');
    const fr_new = document.getElementById('fr_new');
    const modal = document.getElementById('modal');
    const modalName = document.getElementById('modalName');
    const modalImg = document.getElementById('modalImg');
    const modalPrice = document.getElementById('modalPrice');
    const modalStock = document.getElementById('modalStock');
    const custName = document.getElementById('custName');
    const custMobile = document.getElementById('custMobile');
    const custQty = document.getElementById('custQty');

    // Config
    const SHEET_ID = "1SEpFmOEYtJ4Lats3180ENbsxdg13YKk9QDeasqXEiiQ";
    const GVIZ = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    const MANAGER = "9493190130";

    // State
    let users = JSON.parse(localStorage.getItem("cn_users") || "[]");
    let products = [];
    let cart = [];
    const demoOTP = "1234";

    // Auth UI
    function showSignup() { loginBox.style.display='none'; signupBox.style.display='block'; forgotBox.style.display='none'; }
    function showLogin() { loginBox.style.display='block'; signupBox.style.display='none'; forgotBox.style.display='none'; }
    function showForgot() { loginBox.style.display='none'; signupBox.style.display='none'; forgotBox.style.display='block'; }
    function hideOtp() { otpArea.style.display='none'; }

    function signup() {
      const n = su_name.value.trim(), m = su_mobile.value.trim(), p = su_pass.value;
      if (!n || m.length !== 10 || !p) return alert("Enter valid signup details");
      if (users.find(u => u.mobile === m)) return alert("User already exists");
      users.push({ name: n, mobile: m, pass: p });
      localStorage.setItem("cn_users", JSON.stringify(users));
      alert("Account created!");
      showLogin();
    }

    function sendOTP() {
      const m = loginMobile.value.trim();
      if (m.length !== 10) return alert("Enter valid mobile");
      if (!users.find(u => u.mobile === m)) return alert("No user found");
      otpArea.style.display = 'block';
      alert("Demo OTP: " + demoOTP);
    }

    function verifyOTP() {
      if (loginOtp.value.trim() !== demoOTP) return alert("Wrong OTP");
      authCard.style.display = 'none';
      productsCard.style.display = 'block';
      loadProducts();
    }

    function sendForgotOTP() {
      const m = fr_mobile.value.trim();
      if (m.length !== 10) return alert("Enter valid mobile");
      if (!users.find(u => u.mobile === m)) return alert("No user found");
      document.getElementById('forgotOtpArea').style.display = 'block';
      alert("Demo OTP: " + demoOTP);
    }

    function resetPassword() {
      const m = fr_mobile.value.trim(), v = fr_otp.value.trim(), np = fr_new.value;
      if (v !== demoOTP) return alert("Wrong OTP");
      users = users.map(u => u.mobile === m ? { ...u, pass: np } : u);
      localStorage.setItem("cn_users", JSON.stringify(users));
      alert("Password reset!");
      showLogin();
    }

    function skip() {
      authCard.style.display = 'none';
      productsCard.style.display = 'block';
      loadProducts();
    }

    // Load products using GViz
    async function loadProducts() {
      productsDiv.innerHTML = `<p class="muted">Loading products...</p>`;
      products = [];
      try {
        const resp = await fetch(GVIZ);
        const text = await resp.text();
        // Clean the "google.visualization.Query.setResponse(...)" wrapper
        const jsonStr = text
          .substring(text.indexOf("{"), text.lastIndexOf("}") + 1);
        const data = JSON.parse(jsonStr);
        const rows = data.table.rows;

        rows.forEach(r => {
          // Assuming columns: 0 = Name, 1 = Price, 2 = stock, 3 = Img
          const name = r.c[0]?.v;
          const price = r.c[1]?.v;
          const stock = Number(r.c[2]?.v ?? 0);
          const img = r.c[3]?.v;
          products.push({ name, price, stock, img });
        });

        renderProducts();
      } catch (err) {
        console.error("Error fetching sheet", err);
        productsDiv.innerHTML = `<p class="muted">Failed to load products</p>`;
      }
    }

    function renderProducts() {
      if (!products.length) {
        productsDiv.innerHTML = `<p class="muted">No products found</p>`;
        return;
      }
      let html = "";
      products.forEach((p, i) => {
        const avail = p.stock > 0;
        html += `
          <div class="product">
            <img src="${p.img || ''}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
            <h3>${p.name}</h3>
            <div class="price">₹${p.price}</div>
            <div class="${avail ? 'available' : 'unavailable'}">${avail ? 'Available' : 'Not available'}</div>
            <button class="cart-btn" ${!avail ? "disabled" : ""} onclick="addToCart(${i})">Add to Cart</button>
            <button class="cart-btn wa-btn" onclick="orderNow(${i})">Order on WhatsApp</button>
            <button class="cart-btn buy-btn" ${!avail ? "disabled" : ""} onclick="openInstant(${i})">Instant Buy</button>
          </div>
        `;
      });
      productsDiv.innerHTML = html;
    }

    // Cart functions
    function addToCart(i) {
      cart.push(products[i]);
      cartCount.innerText = cart.length;
      alert(`Added: ${products[i].name}`);
    }

    function openCart() {
      productsCard.style.display = 'none';
      cartCard.style.display = 'block';
      renderCart();
    }

    function closeCart() {
      cartCard.style.display = 'none';
      productsCard.style.display = 'block';
    }

    function renderCart() {
      if (!cart.length) {
        cartItems.innerHTML = `<p class="muted">Cart is empty</p>`;
        cartTotal.innerText = "";
        return;
      }
      let html = "";
      let total = 0;
      cart.forEach((p, i) => {
        total += Number(p.price);
        html += `<div style="padding:8px 0; border-bottom:1px solid #eee"><b>${p.name}</b> - ₹${p.price} <button class="small" onclick="removeCart(${i})">Remove</button></div>`;
      });
      cartItems.innerHTML = html;
      cartTotal.innerText = `Total: ₹${total}`;
    }

    function removeCart(i) {
      cart.splice(i, 1);
      cartCount.innerText = cart.length;
      renderCart();
    }

    // WhatsApp order
    function checkout() {
      if (!cart.length) return alert("Cart is empty");
      let msg = `Hello CarryNest Manager,%0AHere is my order:%0A`;
      cart.forEach(p => {
        msg += `${encodeURIComponent(p.name)} - ₹${p.price}%0A`;
      });
      const total = cart.reduce((s, p) => s + Number(p.price), 0);
      msg += `%0ATotal: ₹${total}`;
      window.open(`https://wa.me/${MANAGER}?text=${msg}`, '_blank');
    }

    function orderNow(i) {
      const p = products[i];
      const msg = `Hello CarryNest Manager,%0AI’d like to order:%0A${encodeURIComponent(p.name)} - ₹${p.price}`;
      window.open(`https://wa.me/${MANAGER}?text=${msg}`, '_blank');
    }

    // Instant Buy modal
    function openInstant(i) {
      const p = products[i];
      modalName.innerText = p.name;
      modalImg.src = p.img || '';
      modalPrice.innerText = `₹${p.price}`;
      modalStock.innerText = p.stock > 0 ? "In stock" : "Out of stock";
      window._instant = p;
      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    function placeInstantOrder() {
      const p = window._instant;
      const name = custName.value.trim();
      const mobile = custMobile.value.trim();
      const qty = custQty.value;
      if (!name || mobile.length !== 10) return alert("Enter valid name and mobile");
      const msg = `CarryNest Instant Order%0AProduct: ${encodeURIComponent(p.name)}%0APrice: ₹${p.price}%0AQuantity: ${qty}%0ACustomer: ${encodeURIComponent(name)} (${mobile})`;
      window.open(`https://wa.me/${MANAGER}?text=${msg}`, '_blank');
    }

    function reloadProducts() {
      loadProducts();
    }

    // Initial load
    productsCard.style.display = 'none';
    cartCard.style.display = 'none';
  </script>
</body>
</html>
