<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"/>
<title>Carry Nest | Official Store</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root { --gold: #ffb703; --bg: #030712; --card: #0f0f0f; --red: #ff3131; --green: #25D366; --blue: #2874f0; }
body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg); color: #fff; padding-bottom: 80px; overflow-x: hidden; }

/* STORE CLOSED OVERLAY STYLE */
#store-closed-overlay {
    position: fixed; inset: 0; background: var(--bg); z-index: 99999;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 30px;
}
.closed-box { background: #0f0f0f; padding: 40px 20px; border-radius: 30px; border: 1px solid var(--gold); box-shadow: 0 0 30px rgba(255,183,3,0.2); }
.closed-icon { font-size: 60px; color: var(--gold); margin-bottom: 20px; }

header { background: rgba(19, 25, 33, 0.95); padding: 15px; border-bottom: 1px solid rgba(255,183,3,0.3); position: sticky; top: 0; z-index: 1000; text-align: center; }
.logo-text { font-weight: 900; color: var(--gold); font-size: 22px; letter-spacing: 2px; text-transform: uppercase; margin: 0; }
.loc-tag { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; display: block; }

.container { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; contain: layout; }
.p-card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #222; position: relative; min-height: 270px; }

.img-box { height: 210px; position: relative; background: #111; overflow: hidden; }
.img-box img { width: 100%; height: 100%; object-fit: cover; }
.blurred img { filter: blur(10px); opacity: 0.4; }

.status-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 20; }
.status-tag { background: rgba(0,0,0,0.85); color: #fff; padding: 6px 12px; border-radius: 4px; font-size: 10px; font-weight: 900; border: 1px solid var(--gold); text-transform: uppercase; }
.disc-tag { position: absolute; top: 8px; left: 8px; background: linear-gradient(45deg, #ff3131, #ff9100); color: #fff; font-size: 10px; padding: 4px 8px; font-weight: 900; border-radius: 5px; z-index: 21; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

/* FESTIVAL OFFER STYLING */
.fest-tag-detail { font-size: 11px; color: var(--green); background: rgba(37, 211, 102, 0.1); padding: 2px 8px; border-radius: 4px; font-weight: 900; margin-left: 10px; border: 1px solid rgba(37, 211, 102, 0.3); vertical-align: middle; }

.input-error { border: 1px solid var(--red) !important; animation: shake 0.3s ease-in-out; background: rgba(255,49,49,0.05) !important; }
@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
.warning-toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--red); color: #fff; padding: 10px 20px; border-radius: 50px; font-weight: 900; font-size: 12px; z-index: 10000; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

.size-error-shake { animation: shake 0.4s ease-in-out; border: 1px solid var(--red) !important; }

.nav-bar { position: fixed; bottom: 0; width: 100%; background: #0f172a; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; z-index: 2000; }
.nav-item { text-align: center; color: #888; font-size: 12px; cursor: pointer; flex: 1; }
.nav-item.active { color: var(--gold); }

#sheet, #account-view, #wishlist-view, #modal, #orders-view, #order-detail-view, #success-screen, #reason-view { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; overflow-y: auto; }
#reason-view { background: rgba(0,0,0,0.8); align-items: flex-end; display: none; }

.reason-container { background: #111; width: 100%; border-radius: 25px 25px 0 0; padding: 20px; box-sizing: border-box; border-top: 2px solid var(--gold); animation: slideUp 0.3s ease-out; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.back-btn { padding: 20px; color: var(--gold); cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }

.order-card { background: #0f0f0f; padding: 15px; border-radius: 16px; border: 1px solid #222; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
.order-img { width: 65px; height: 65px; border-radius: 10px; object-fit: cover; background: #222; }
.order-info { flex: 1; }
.order-id-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
.order-name { font-size: 14px; font-weight: 600; color: #fff; margin: 2px 0; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
.status-pill { display: inline-block; padding: 3px 10px; border-radius: 50px; font-size: 10px; font-weight: 900; margin-top: 5px; text-transform: uppercase; }
.st-NEW { background: rgba(40, 116, 240, 0.15); color: var(--blue); border: 1px solid var(--blue); }
.st-DELIVERED { background: rgba(37, 211, 102, 0.15); color: var(--green); border: 1px solid var(--green); }
.st-CANCELLED { background: rgba(255, 49, 49, 0.15); color: var(--red); border: 1px solid var(--red); }
.st-CONFIRMED { background: rgba(255, 183, 3, 0.15); color: var(--gold); border: 1px solid var(--gold); }
.st-RETURN_REQUESTED { background: rgba(255, 159, 67, 0.15); color: #ff9f43; border: 1px solid #ff9f43; }
.st-EXCHANGE_REQUESTED { background: rgba(165, 94, 234, 0.15); color: #a55eea; border: 1px solid #a55eea; }

.detail-box { background: #0f0f0f; margin: 15px; padding: 25px; border-radius: 24px; border: 1px solid #222; }
.bill-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
.timer-text { color: var(--red); font-weight: bold; font-size: 13px; margin-top: 10px; background: rgba(255,49,49,0.1); padding: 8px; border-radius: 8px; text-align: center; }
.btn-main { width: 100%; padding: 16px; background: var(--green); color: #fff; border: none; border-radius: 12px; font-weight: 900; margin-top: 15px; cursor: pointer; }

#success-screen { background: var(--bg); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; z-index: 4000; }
.check-icon { width: 80px; height: 80px; background: var(--green); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #fff; margin-bottom: 20px; }
.s-grid div { border: 1px solid #333; padding: 12px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
.s-grid div.active { border-color: var(--gold); background: rgba(255,183,3,0.1); color: var(--gold); font-weight: 900; }
.s-grid div.disabled { opacity: 0.2; text-decoration: line-through; pointer-events: none; }

.reason-item { background: #1a1a1a; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #333; cursor: pointer; text-align: center; font-weight: 600; font-size: 14px; color: #fff; }
.reason-item:active { background: var(--gold); color: #000; }

.search-container { padding: 10px 15px; }
.search-input { width: 100%; padding: 12px; border-radius: 12px; background: #111; border: 1px solid #333; color: #fff; font-family: 'Outfit'; outline: none; }

.rev-card { background: #0a0a0a; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 3px solid var(--gold); }
.rev-name { font-weight: 900; font-size: 13px; color: var(--gold); }
.rev-text { font-size: 12px; color: #ccc; margin-top: 4px; }

/* AI CHATBOT EXTRA CSS */
.ai-btn { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-size: 24px; z-index: 2500; box-shadow: 0 5px 15px rgba(255,183,3,0.3); cursor: pointer; border: none; }
#ai-window { position: fixed; bottom: 155px; right: 20px; width: 320px; height: 450px; background: #0a0a0a; border: 1px solid var(--gold); border-radius: 20px; display: none; flex-direction: column; z-index: 3500; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
.ai-header { background: var(--gold); color: #000; padding: 15px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
#ai-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 13px; scroll-behavior: smooth; }
.msg-ai { background: #1a1a1a; padding: 10px 14px; border-radius: 15px 15px 15px 5px; align-self: flex-start; color: #eee; border: 1px solid #222; max-width: 80%; }
.msg-user { background: var(--gold); color: #000; padding: 10px 14px; border-radius: 15px 15px 5px 15px; align-self: flex-end; font-weight: 600; max-width: 80%; }
.ai-input-area { padding: 12px; border-top: 1px solid #222; display: flex; gap: 8px; background: #0f0f0f; }
.ai-input-area input { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 10px; outline: none; font-family: 'Outfit'; }
.ai-input-area button { background: var(--gold); border: none; width: 40px; border-radius: 10px; cursor: pointer; color: #000; font-size: 16px; }
</style>
</head>
<body>

<button class="ai-btn" onclick="toggleAI()"><i class="fas fa-robot"></i></button>
<div id="ai-window">
    <div class="ai-header">
        <span><i class="fas fa-robot"></i> CARRY NEST BOT</span>
        <i class="fas fa-times" onclick="toggleAI()" style="cursor:pointer"></i>
    </div>
    <div id="ai-messages">
        <div class="msg-ai">Namaste! How can I help you today regarding our store or products? You can ask about "Founder", "How to Order", or "Returns".</div>
    </div>
    <div class="ai-input-area">
        <input type="text" id="ai-query" placeholder="Type your doubt..." onkeypress="if(event.key==='Enter') sendToAI()">
        <button onclick="sendToAI()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="warning-toast" class="warning-toast">‚ö†Ô∏è Please select a size!</div>

<div id="store-closed-overlay">
    <div class="closed-box">
        <div class="closed-icon"><i class="fas fa-store-slash"></i></div>
        <h2 style="color:var(--gold); font-weight:900; margin:0;">STORE CLOSED</h2>
        <p style="color:#888; margin-top:10px;">‡∞®‡∞Æ‡∞∏‡±ç‡∞§‡±á! ‡∞Æ‡±á‡∞Æ‡±Å ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å ‡∞§‡±Ä‡∞∏‡±Å‡∞ï‡±ã‡∞µ‡∞°‡∞Ç ‡∞≤‡±á‡∞¶‡±Å. ‡∞§‡±ç‡∞µ‡∞∞‡∞≤‡±ã‡∞®‡±á ‡∞Æ‡∞≥‡±ç‡∞≥‡±Ä ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã‡∞ï‡∞ø ‡∞µ‡∞∏‡±ç‡∞§‡∞æ‡∞Æ‡±Å.</p>
        <p style="color:#555; font-size:12px; font-style:italic;">We are temporarily not accepting orders. Please check back later!</p>
    </div>
</div>

<header>
    <div class="logo-text">Carry Nest</div>
    <span class="loc-tag"><i class="fas fa-location-dot"></i> Durki, Telangana</span>
</header>

<div id="home-view">
    <div id="promo-banner" style="margin:12px;background:linear-gradient(45deg,#ffb703,#ff9100); padding:12px;border-radius:14px;color:#000;font-weight:900;text-align:center;">
        ‚úÖ 100% Secure Checkout ‚Ä¢ Easy 24-Hour Returns ‚Ä¢ Cash on Delivery
    </div>
    
    <div class="search-container">
        <input type="text" id="searchBar" class="search-input" onkeyup="searchProduct()" placeholder="Search for products...">
    </div>

    <div id="grid" class="container"></div>

    <div style="text-align:center;color:#555;font-size:11px;margin:20px 0;">
        ¬© 2026 Carry Nest ‚Ä¢ Made with ‚ù§Ô∏è in Durki
    </div>
</div>

<div id="reason-view" onclick="if(event.target==this) this.style.display='none'">
    <div class="reason-container">
        <div id="reason-title" style="text-align:center; color:var(--gold); font-weight:900; margin-bottom:15px; font-size:16px;">SELECT A REASON</div>
        <div id="reason-list"></div>
        <button onclick="document.getElementById('reason-view').style.display='none'" style="width:100%; background:transparent; color:#666; border:none; padding:10px; font-weight:bold; cursor:pointer;">Cancel</button>
    </div>
</div>

<div id="success-screen">
    <div class="check-icon" id="sc-icon"><i class="fas fa-check"></i></div>
    <h1 id="sc-title" style="color:var(--gold); margin:0; letter-spacing:2px; font-weight:900;">CONGRATULATIONS</h1>
    <p id="sc-msg" style="font-size:18px; color:#fff; margin-top:10px;">Order Placed Successfully!</p>
    
    <div id="order-receipt" style="background:#0f0f0f; border:1px solid #222; padding:15px; border-radius:15px; width:80%; margin-top:20px; text-align:left;">
        <div style="color:var(--gold); font-size:12px; font-weight:900; margin-bottom:10px; border-bottom:1px solid #222; padding-bottom:5px;">ORDER SUMMARY</div>
        <div class="bill-row"><span>Order ID:</span><b id="rec-id" style="color:var(--blue)"></b></div>
        <div class="bill-row"><span>Product:</span><b id="rec-name"></b></div>
        <div class="bill-row"><span>Size:</span><b id="rec-size"></b></div>
        <div class="bill-row" style="margin-top:5px; padding-top:5px; border-top:1px dashed #333;"><span>Total Amount:</span><b id="rec-total" style="color:var(--green)"></b></div>
    </div>

    <div style="margin-top:20px; width:80%;">
        <p style="font-size:14px; color:#aaa; font-style:italic;">Thank you for becoming a Carry Nest Family member</p>
        <button onclick="goHome()" style="background:var(--gold); color:#000; border:none; padding:12px 30px; border-radius:30px; font-weight:900; margin-top:25px; cursor:pointer; font-family:'Outfit'; text-transform:uppercase;">Back to Home</button>
    </div>
</div>

<div id="account-view" style="padding:20px;">
    <div class="back-btn" onclick="switchTab('home')"><i class="fas fa-arrow-left"></i> Back</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
        <div style="background:#111; padding:20px; border-radius:15px; border:1px solid #222; text-align:center;" onclick="openOrders()"><i class="fas fa-box fa-2x" style="color:var(--blue); margin-bottom:10px;"></i><br>My Orders</div>
        <div style="background:#111; padding:20px; border-radius:15px; border:1px solid #222; text-align:center;" onclick="switchTab('wishlist')"><i class="fas fa-heart fa-2x" style="color:var(--red); margin-bottom:10px;"></i><br>Wishlist</div>
        <div style="background:#111; padding:20px; border-radius:15px; border:1px solid #222; text-align:center;" onclick="window.open('https://www.instagram.com/carrynest.india?igsh=MXdsZ2p5emZ6b2FxNg==', '_blank')"><i class="fab fa-instagram fa-2x" style="color:#E1306C; margin-bottom:10px;"></i><br>Instagram</div>
        <div style="background:#111; padding:20px; border-radius:15px; border:1px solid #222; text-align:center;" onclick="window.location.href='mailto:support@carrynest.in'"><i class="fas fa-headset fa-2x" style="color:var(--green); margin-bottom:10px;"></i><br>Support</div>
    </div>
</div>

<div id="wishlist-view" style="padding:20px;">
    <div class="back-btn" onclick="switchTab('home')"><i class="fas fa-arrow-left"></i> Back</div>
    <div id="wish-grid" class="container"></div>
</div>

<div id="orders-view">
    <div class="back-btn" onclick="document.getElementById('orders-view').style.display='none'"><i class="fas fa-arrow-left"></i> Back</div>
    <div style="padding:0 20px;">
        <div style="display:flex; gap:10px; margin-bottom:25px; background: #111; padding: 15px; border-radius: 15px; border: 1px solid #222;">
            <input type="tel" id="track-phone" placeholder="Registered WhatsApp Number" style="flex:1; padding:12px; border-radius:10px; background:#000; border:1px solid #333; color:#fff; font-family:'Outfit'; outline:none;">
            <button onclick="fetchOrders()" id="find-btn" style="background:var(--gold); border:none; padding:10px 20px; border-radius:10px; font-weight:900; color:#000;">FIND</button>
        </div>
        <div id="orders-list"></div>
    </div>
</div>

<div id="order-detail-view">
    <div class="back-btn" onclick="document.getElementById('order-detail-view').style.display='none'"><i class="fas fa-arrow-left"></i> Back</div>
    <div id="order-details-content"></div>
</div>

<div id="sheet">
    <div style="padding: 20px; display:flex; justify-content:space-between; align-items:center;">
        <div onclick="closeSheet()" style="color:#fff; cursor:pointer;"><i class="fas fa-arrow-left"></i> Back</div>
        <i id="wish-btn" class="far fa-heart" style="font-size:22px;" onclick="toggleWish()"></i>
    </div>
    <div id="v-img" style="text-align:center;"></div>
    <div style="padding:25px; background:#030712; border-top:1px solid var(--gold); border-radius:30px 30px 0 0; margin-top:-30px;">
        <h2 id="v-title" style="margin:0;"></h2>
        <div style="margin:10px 0;">
            <span id="v-sell" style="font-size:24px; font-weight:900; color:var(--gold);"></span>
            <span id="v-mrp" style="text-decoration:line-through; color:#666; margin-left:10px; font-size:16px;"></span>
        </div>
        <div id="v-sizes" class="s-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin: 20px 0;"></div>
        <button id="buy-btn" class="btn-main" onclick="openForm()">Buy Now</button>

        <div style="margin-top: 30px; border-top: 1px solid #222; padding-top: 20px;">
            <h3 style="font-size: 16px; color: var(--gold);">Customer Reviews</h3>
            <div style="background: #111; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #222;">
                <input type="text" id="rev-name" placeholder="Your Name" style="width:100%; background:none; border:1px solid #333; color:#fff; padding:10px; margin-bottom:8px; border-radius:8px; outline:none; box-sizing: border-box;">
                <textarea id="rev-text" placeholder="Write your review..." style="width:100%; background:none; border:1px solid #333; color:#fff; padding:10px; border-radius:8px; height:60px; outline:none; resize:none; box-sizing: border-box;"></textarea>
                <button id="post-rev-btn" style="background:var(--gold); color:#000; border:none; padding:10px 15px; border-radius:8px; font-weight:900; margin-top:10px; cursor:pointer; width:100%;">Post Review</button>
            </div>
            <div id="reviews-container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div id="modal">
    <div style="background:#fff; color:#000; width:92%; max-width:400px; margin:30px auto; border-radius:24px; padding:25px; box-sizing: border-box;">
        <div onclick="document.getElementById('modal').style.display='none'" style="cursor:pointer; color:#666; font-size:14px; margin-bottom:10px; display:inline-block;"><i class="fas fa-arrow-left"></i> Back</div>
        <h3 style="margin-top:0;">Checkout Details</h3>
        <div id="modal-bill-box" style="background:#f9f9f9; padding:12px; border-radius:12px; margin-bottom:15px; font-size:13px; border:1px solid #eee;">
            </div>
        <input type="text" id="f-name" placeholder="Full Name" style="width:100%; padding:12px; margin-top:10px; border:1px solid #ddd; border-radius:10px; box-sizing: border-box;">
        <input type="tel" id="f-phone" placeholder="WhatsApp Number" style="width:100%; padding:12px; margin-top:10px; border:1px solid #ddd; border-radius:10px; box-sizing: border-box;">
        <input type="text" id="f-addr" placeholder="Detailed Address" style="width:100%; padding:12px; margin-top:10px; border:1px solid #ddd; border-radius:10px; box-sizing: border-box;">
        <input type="number" id="f-pin" placeholder="Pincode (503301)" oninput="checkPin()" style="width:100%; padding:12px; margin-top:10px; border:1px solid #ddd; border-radius:10px; box-sizing: border-box;">
        <button class="btn-main" id="confirm-btn" onclick="placeOrder()" disabled style="opacity: 0.5;">Confirm Order</button>
    </div>
</div>

<div class="nav-bar">
    <div class="nav-item active" id="nav-home" onclick="switchTab('home')"><i class="fas fa-home"></i><br>Home</div>
    <div class="nav-item" id="nav-wish" onclick="switchTab('wishlist')"><i class="fas fa-heart"></i><br>Wishlist</div>
    <div class="nav-item" id="nav-acc" onclick="switchTab('account')"><i class="fas fa-user"></i><br>Account</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, doc, updateDoc, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyDijunsZZH2NuutbuzGoMOvG3hD8nrliwY", authDomain: "carry-nest-admin.firebaseapp.com", projectId: "carry-nest-admin" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const SHEET_ID = "1SEpFmOEYtJ4Lats3180ENbsxdg13YKk9QDeasqXEiiQ";
let products = [], currentP = null, selectedS = null, myOrders = [], timerInt = null, currentOID = "";
let wishlist = JSON.parse(localStorage.getItem('cn_wish')) || [];
let inventoryStatus = {};

// --- Festival Offers Configuration ---
const FESTIVAL_OFFERS = [
    {
        name: "SANKRANTHI SPECIAL",
        startDate: "2026-01-10",
        endDate: "2026-01-20",
        discountPercent: 10,
        message: "üåæ Sankranthi Offers: Flat 10% OFF on Everything!"
    },
    {
        name: "REPUBLIC DAY SALE",
        startDate: "2026-01-24",
        endDate: "2026-01-27",
        discountPercent: 15,
        message: "üáÆüá≥ Republic Day Sale: 15% OFF!"
    }
];

function getActiveOffer() {
    const today = new Date().toISOString().split('T')[0];
    return FESTIVAL_OFFERS.find(o => today >= o.startDate && today <= o.endDate);
}

async function loadData() {
    const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`);
    const text = await res.text();
    const data = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
    
    const offer = getActiveOffer();
    
    products = data.table.rows.map(r => {
        let originalPrice = Number(r.c[3]?.v || 0);
        let mrpPrice = Number(r.c[2]?.v || 0);
        let finalPrice = originalPrice;
        let festDiscountAmt = 0;
        
        // Apply Festival Discount if active
        if(offer) {
            festDiscountAmt = Math.floor(originalPrice * (offer.discountPercent / 100));
            finalPrice = originalPrice - festDiscountAmt;
        }
        
        return {
            id: String(r.c[0]?.v || ""), name: String(r.c[1]?.v || ""), mrp: mrpPrice, 
            basePrice: originalPrice, // Original Selling Price (before fest discount)
            price: finalPrice,
            festDiscount: festDiscountAmt, // The amount saved via festival
            cat: String(r.c[4]?.v || "All"), img: String(r.c[5]?.v || ""),
            stock: { S: Number(r.c[6]?.v || 0), M: Number(r.c[7]?.v || 0), L: Number(r.c[8]?.v || 0), XL: Number(r.c[9]?.v || 0) },
            status: String(r.c[10]?.v || "").trim(), delivery: Number(r.c[11]?.v || 0),
            hasFestivalOffer: !!offer
        };
    });

    if(offer) {
        const banner = document.getElementById('promo-banner');
        if(banner) banner.innerText = "üéâ " + offer.message;
    }

    renderUI(products, 'grid');
}

onSnapshot(doc(db, "settings", "inventory"), (snap) => {
    if(snap.exists()) {
        inventoryStatus = snap.data();
        renderUI(products, 'grid');
        if(currentP) updateSheetStock(currentP.id);
    }
});

function renderUI(items, target) {
    let html = '';
    items.forEach(p => {
        const adminOutOfStock = inventoryStatus[p.name] === false;
        const isSold = p.status.toUpperCase() === 'SOLD OUT' || p.status.toUpperCase() === 'COMING SOON' || adminOutOfStock;
        const displayStatus = adminOutOfStock ? 'SOLD OUT' : p.status;
        
        const disc = p.mrp > p.price ? Math.round(((p.mrp - p.price) / p.mrp) * 100) : 0;
        
        html += `<div class="p-card" onclick="openProduct('${p.id}')">
            <div class="img-box ${isSold ? 'blurred' : ''}">
                ${disc > 0 && !isSold ? `<div class="disc-tag"><i class="fas fa-fire"></i> ${disc}% OFF</div>` : ''}
                ${isSold ? `<div class="status-overlay"><div class="status-tag">${displayStatus}</div></div>` : ''}
                <img src="${p.img}" loading="lazy">
            </div>
            <div style="padding:12px;">
                <div style="font-size:12px; color:#bbb; height:34px; overflow:hidden;">${p.name}</div>
                <div style="margin-top:4px;">
                    <span style="font-size:16px; font-weight:900; color:var(--gold);">‚Çπ${p.price}</span>
                    ${p.mrp > p.price ? `<span style="font-size:11px; text-decoration:line-through; color:#666; margin-left:6px;">‚Çπ${p.mrp}</span>` : ''}
                </div>
            </div>
        </div>`;
    });
    document.getElementById(target).innerHTML = html || '<p style="text-align:center;width:100%;color:#666;">No items found.</p>';
}

window.searchProduct = () => {
    let term = document.getElementById('searchBar').value.toLowerCase();
    let filtered = products.filter(p => p.name.toLowerCase().includes(term));
    renderUI(filtered, 'grid');
};

window.checkPin = () => {
    const pin = document.getElementById('f-pin').value;
    const btn = document.getElementById('confirm-btn');
    if(pin === "503301") {
        btn.disabled = false;
        btn.style.opacity = "1";
    } else {
        btn.disabled = true;
        btn.style.opacity = "0.5";
        if(pin.length >= 6) {
            alert("Sorry! Delivery is only available for 503301 (Durki).");
            document.getElementById('f-pin').value = "";
        }
    }
};

window.placeOrder = () => {
    const nameInput = document.getElementById('f-name');
    const phoneInput = document.getElementById('f-phone');
    const addrInput = document.getElementById('f-addr');
    const toast = document.getElementById('warning-toast');

    let isValid = true;
    [nameInput, phoneInput, addrInput].forEach(el => {
        if(!el.value.trim()){ el.classList.add('input-error'); isValid = false; }
        else { el.classList.remove('input-error'); }
    });

    if(!isValid) {
        toast.innerText = "‚ö†Ô∏è Please fill all details!";
        toast.style.display = 'block';
        if(window.navigator.vibrate) window.navigator.vibrate(50);
        setTimeout(() => toast.style.display = 'none', 2500);
        return;
    }

    const btn = document.getElementById('confirm-btn'); 
    btn.disabled = true; 

    document.getElementById('rec-id').innerText = currentOID;
    document.getElementById('rec-name').innerText = currentP.name;
    document.getElementById('rec-size').innerText = selectedS;
    document.getElementById('rec-total').innerText = "‚Çπ" + (currentP.price + currentP.delivery);

    document.getElementById('modal').style.display = 'none'; 
    document.getElementById('sheet').style.display = 'none';
    document.getElementById('success-screen').style.display = 'flex';
    
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

    const orderData = {
        orderID: currentOID, 
        customer: nameInput.value, 
        phone: phoneInput.value,
        address: addrInput.value, 
        product: currentP.name, 
        img: currentP.img, 
        size: selectedS, 
        price: currentP.price,
        deliveryCharge: currentP.delivery, 
        total: (currentP.price + currentP.delivery), 
        status: "NEW", 
        createdAt: serverTimestamp()
    };

    addDoc(collection(db, "orders"), orderData).catch(e => console.error(e));
};

window.openProduct = (id) => {
    currentP = products.find(x => x.id === id); 
    selectedS = null; 
    updateSheetStock(id);
    loadReviews(id);
    document.getElementById('sheet').style.display = 'block';
};

function updateSheetStock(id) {
    const p = products.find(x => x.id === id);
    if(!p) return;
    const adminOutOfStock = inventoryStatus[p.name] === false;
    const isSold = p.status.toUpperCase().includes('SOLD') || p.status.toUpperCase().includes('COMING') || adminOutOfStock;
    
    document.getElementById('v-title').innerText = p.name; 
    
    let sellPriceHtml = `‚Çπ${p.price}`;
    if(p.festDiscount > 0) {
        sellPriceHtml += `<span class="fest-tag-detail">-${p.festDiscount} Festival Off</span>`;
    }
    document.getElementById('v-sell').innerHTML = sellPriceHtml;
    
    document.getElementById('v-mrp').innerText = p.mrp > p.price ? '‚Çπ' + p.mrp : '';
    document.getElementById('v-img').innerHTML = `<img src="${p.img}" style="width:100%;height:300px;object-fit:contain">`;
    
    let sH = ''; 
    ['S','M','L','XL'].forEach(s => { 
        let qty = p.stock[s];
        let stockTag = qty > 0 ? `<div style="font-size:9px; color:${qty < 5 ? 'var(--red)' : '#888'}">${qty} left</div>` : '';
        
        sH += qty > 0 
            ? `<div id="sz-${s}" onclick="setS('${s}')" style="display:flex; flex-direction:column; align-items:center; padding:10px 0;">
                <span>${s}</span>
                ${stockTag}
               </div>` 
            : `<div class="disabled">${s}</div>`; 
    });
    
    document.getElementById('v-sizes').innerHTML = sH; 
    const buyBtn = document.getElementById('buy-btn');
    buyBtn.disabled = isSold; 
    buyBtn.innerText = adminOutOfStock ? "SOLD OUT" : (isSold ? p.status : "Buy Now");
    updateWishIcon();
}

async function loadReviews(pid) {
    const q = query(collection(db, "reviews"), where("productId", "==", pid), orderBy("timestamp", "desc"));
    onSnapshot(q, (snap) => {
        let h = '';
        snap.forEach(d => {
            const r = d.data();
            h += `<div class="rev-card">
                <div class="rev-name">${r.userName}</div>
                <div class="rev-text">${r.comment}</div>
            </div>`;
        });
        document.getElementById('reviews-container').innerHTML = h || '<p style="color:#555; font-size:12px; text-align:center;">No reviews yet. Be the first to review!</p>';
    });
}

document.getElementById('post-rev-btn').onclick = async () => {
    const name = document.getElementById('rev-name').value;
    const text = document.getElementById('rev-text').value;
    if(!name || !text) return alert("Please enter name and review!");
    
    try {
        await addDoc(collection(db, "reviews"), {
            productId: currentP.id,
            userName: name,
            comment: text,
            timestamp: serverTimestamp()
        });
        document.getElementById('rev-name').value = '';
        document.getElementById('rev-text').value = '';
    } catch(e) { alert("Error posting review"); }
};

window.openForm = () => { 
    if(!selectedS) {
        const sizeGrid = document.getElementById('v-sizes');
        const toast = document.getElementById('warning-toast');
        sizeGrid.classList.add('size-error-shake');
        toast.innerText = "‚ö†Ô∏è Please select a size!";
        toast.style.display = 'block';
        if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(50);
        setTimeout(() => { 
            sizeGrid.classList.remove('size-error-shake');
            toast.style.display = 'none';
        }, 1500);
        return;
    }
    currentOID = "CN-" + Math.floor(1000 + Math.random() * 9000); 

    let billHtml = `
        <div class="bill-row"><span>Order ID:</span><b style="color:var(--blue);">${currentOID}</b></div>
        <div class="bill-row"><span>Item Price:</span><b>‚Çπ${currentP.basePrice}</b></div>
        ${currentP.festDiscount > 0 ? `<div class="bill-row" style="color:var(--green)"><span>Festival Off:</span><b>-‚Çπ${currentP.festDiscount}</b></div>` : ''}
        <div class="bill-row"><span>Delivery:</span><b style="color:var(--green);">‚Çπ${currentP.delivery}</b></div>
        <hr style="border:0; border-top:1px solid #eee; margin:8px 0;">
        <div class="bill-row" style="font-size:15px; font-weight:900;"><span>Total Amount:</span><span style="color:var(--red);">‚Çπ${currentP.price + currentP.delivery}</span></div>
    `;
    document.getElementById('modal-bill-box').innerHTML = billHtml;
    document.getElementById('modal').style.display = 'block'; 
};

window.setS = (s) => { 
    selectedS = s; 
    document.querySelectorAll('.s-grid div').forEach(b => b.classList.remove('active', 'size-error-shake')); 
    document.getElementById('sz-'+s).classList.add('active'); 
};

window.fetchOrders = async () => {
    const phone = document.getElementById('track-phone').value; if(!phone) return alert("Enter Number");
    const q = query(collection(db, "orders"), where("phone", "==", phone));
    const snap = await getDocs(q); myOrders = []; let h = '';
    snap.forEach(d => {
        const o = d.data(); o.id = d.id; myOrders.push(o);
        h += `<div class="order-card" onclick="viewOrderDetails('${o.id}')">
            <img src="${o.img}" class="order-img">
            <div class="order-info">
                <div class="order-id-label">ID: ${o.orderID || o.id.slice(0,6)}</div>
                <div class="order-name">${o.product}</div>
                <div style="font-size:12px; font-weight:900; color:var(--gold);">‚Çπ${o.total}</div>
                <div class="status-pill st-${o.status}">${o.status.replace('_',' ')}</div>
            </div>
        </div>`;
    });
    document.getElementById('orders-list').innerHTML = h || '<p style="text-align:center; padding:40px; color:#555;">No Orders Found</p>';
};

window.viewOrderDetails = (id) => {
    const o = myOrders.find(x => x.id === id);
    const orderTime = o.createdAt ? o.createdAt.toDate() : new Date();
    const returnExp = orderTime.getTime() + (24 * 60 * 60 * 1000);
    const canReturn = o.status === 'DELIVERED' && new Date().getTime() < returnExp;
    const canCancel = o.status === 'NEW' || o.status === 'CONFIRMED';

    if(timerInt) clearInterval(timerInt);
    const updateTimer = () => {
        const diff = returnExp - new Date().getTime();
        const el = document.getElementById('return-timer');
        if(diff <= 0) { if(el) el.innerHTML = "Return period ended"; clearInterval(timerInt); }
        else { const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000); if(el) el.innerHTML = `<i class="fas fa-clock"></i> Request period ends in: ${h}h ${m}m`; }
    };
    document.getElementById('order-details-content').innerHTML = `
        <div class="detail-box">
            <div style="text-align:center; margin-bottom:20px;">
                <img src="${o.img}" style="width:140px; height:140px; border-radius:15px; object-fit:cover; margin-bottom:12px; border:1px solid #222;">
                <div class="status-pill st-${o.status}" style="font-size:12px; padding:5px 15px;">${o.status.replace('_',' ')}</div>
                <div id="return-timer" class="timer-text" style="display:${o.status==='DELIVERED'?'block':'none'}"></div>
            </div>
            <div style="background:#000; padding:15px; border-radius:15px; border:1px solid #222; margin-bottom:15px;">
                <div class="bill-row"><span>Order ID</span><b style="color:var(--blue)">${o.orderID || 'N/A'}</b></div>
                <div class="bill-row"><span>Product</span><b>${o.product}</b></div>
                <div class="bill-row"><span>Size</span><b style="color:var(--gold)">${o.size}</b></div>
            </div>
            ${canReturn ? `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-main" style="background:#a55eea; margin-top:0;" onclick="showExchangeSelection('${o.id}')">Exchange</button>
                    <button class="btn-main" style="margin-top:0;" onclick="showReasons('${o.id}', 'RETURN_REQUESTED')">Return</button>
                </div>
            ` : ''}
            ${canCancel ? `<button class="btn-main" style="background:var(--red)" onclick="showReasons('${o.id}', 'CANCELLED')">Cancel Order</button>` : ''}
        </div>`;
    document.getElementById('order-detail-view').style.display = 'block';
    if(o.status === 'DELIVERED') { updateTimer(); timerInt = setInterval(updateTimer, 60000); }
};

window.showExchangeSelection = (orderDbId) => {
    const o = myOrders.find(x => x.id === orderDbId);
    const p = products.find(x => x.name === o.product);
    if(!p) return alert("Product data not found!");
    let sizeHtml = '';
    ['S','M','L','XL'].forEach(s => {
        let qty = p.stock[s];
        if(s === o.size) sizeHtml += `<div class="disabled" style="opacity:0.5; border:1px dashed #444;">${s}<br><small>Current</small></div>`;
        else if(qty > 0) sizeHtml += `<div id="ex-sz-${s}" onclick="selectExchangeSize('${s}')" style="padding:10px 0; border:1px solid #333; border-radius:10px; cursor:pointer;">${s}<br><small>${qty} left</small></div>`;
        else sizeHtml += `<div class="disabled">${s}</div>`;
    });
    document.getElementById('reason-title').innerText = "CHOOSE NEW SIZE";
    document.getElementById('reason-list').innerHTML = `<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:20px;" id="ex-grid">${sizeHtml}</div><button id="ex-confirm-btn" class="btn-main" style="background:#a55eea; margin-top:10px; opacity:0.5;" disabled onclick="processExchange('${orderDbId}')">Confirm Exchange</button>`;
    document.getElementById('reason-view').style.display = 'flex';
};

let exchangeSelectedSize = null;
window.selectExchangeSize = (s) => {
    exchangeSelectedSize = s;
    document.querySelectorAll('#ex-grid > div').forEach(d => { if(!d.classList.contains('disabled')) { d.style.borderColor = "#333"; d.style.background = "transparent"; } });
    const selectedEl = document.getElementById('ex-sz-'+s);
    if(selectedEl) { selectedEl.style.borderColor = "var(--gold)"; selectedEl.style.background = "rgba(255,183,3,0.1)"; }
    document.getElementById('ex-confirm-btn').disabled = false;
    document.getElementById('ex-confirm-btn').style.opacity = "1";
};

window.processExchange = async (id) => { if(!exchangeSelectedSize) return; confirmStatusUpdate(id, 'EXCHANGE_REQUESTED', 'Size Exchange to: ' + exchangeSelectedSize); };

window.showReasons = (id, type) => {
    let list = [], title = "SELECT A REASON";
    if(type === 'CANCELLED') list = ["Ordered by mistake", "Better price found", "Changed my mind", "Delayed shipping", "Wrong size"];
    else { title = "REASON FOR RETURN"; list = ["Size doesn't fit", "Product damaged", "Wrong item", "Quality issue", "Color mismatch"]; }
    document.getElementById('reason-title').innerText = title;
    let html = '';
    list.forEach(r => { html += `<div class="reason-item" onclick="confirmStatusUpdate('${id}', '${type}', '${r}')">${r}</div>`; });
    document.getElementById('reason-list').innerHTML = html;
    document.getElementById('reason-view').style.display = 'flex';
};

window.confirmStatusUpdate = async (id, s, reason) => {
    try {
        await updateDoc(doc(db, "orders", id), { status: s, reason: reason });
        document.getElementById('reason-view').style.display = 'none';
        document.getElementById('order-detail-view').style.display = 'none';
        document.getElementById('orders-view').style.display = 'none';
        document.getElementById('account-view').style.display = 'none';
        let scTitle = "REQUESTED", scMsg = "Request submitted", scColor = "var(--gold)";
        if(s === 'CANCELLED') { scTitle = "CANCELLED"; scMsg = "Order cancelled successfully"; scColor = "var(--red)"; }
        else if(s === 'EXCHANGE_REQUESTED') { scTitle = "EXCHANGE"; scMsg = "Exchange request submitted"; scColor = "#a55eea"; }
        document.getElementById('sc-title').innerText = scTitle;
        document.getElementById('sc-msg').innerText = scMsg;
        document.getElementById('sc-icon').style.background = scColor;
        document.getElementById('success-screen').style.display = 'flex';
    } catch (e) { alert("Error updating status"); }
};

window.goHome = () => { document.getElementById('success-screen').style.display = 'none'; switchTab('home'); };
window.switchTab = (t) => { document.getElementById('home-view').style.display = t==='home'?'block':'none'; document.getElementById('account-view').style.display = t==='account'?'block':'none'; document.getElementById('wishlist-view').style.display = t==='wishlist'?'block':'none'; if(t==='wishlist') renderUI(wishlist, 'wish-grid'); document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); document.getElementById('nav-' + t.slice(0, 4)).classList.add('active'); };
window.toggleWish = () => { const i = wishlist.findIndex(x=>x.id===currentP.id); i>-1?wishlist.splice(i,1):wishlist.push(currentP); localStorage.setItem('cn_wish', JSON.stringify(wishlist)); updateWishIcon(); };
function updateWishIcon() { const btn = document.getElementById('wish-btn'); if(btn && currentP) { const isW = wishlist.some(x=>x.id===currentP.id); btn.className = isW ? 'fas fa-heart' : 'far fa-heart'; btn.style.color = isW ? 'var(--red)' : '#fff'; } }
window.openOrders = () => { document.getElementById('orders-view').style.display = 'block'; };
window.closeSheet = () => { document.getElementById('sheet').style.display = 'none'; if(timerInt) clearInterval(timerInt); };

onSnapshot(doc(db, "settings", "store"), (snap) => { if(snap.exists()){ const isOpen = snap.data().isOpen; document.getElementById('store-closed-overlay').style.display = isOpen ? 'none' : 'flex'; } });

loadData();
</script>

<script>
function toggleAI() {
    const win = document.getElementById('ai-window');
    win.style.display = (win.style.display === 'flex') ? 'none' : 'flex';
}

function sendToAI() {
    const input = document.getElementById('ai-query');
    const logs = document.getElementById('ai-messages');
    const query = input.value.trim().toLowerCase();
    if(!query) return;

    logs.innerHTML += `<div class="msg-user">${input.value}</div>`;
    const userVal = input.value;
    input.value = '';
    
    const tempId = 'ai-loading-' + Date.now();
    logs.innerHTML += `<div class="msg-ai" id="${tempId}">...</div>`;
    logs.scrollTop = logs.scrollHeight;

    setTimeout(() => {
        let response = "";

        if (query.includes("founder") || query.includes("owner") || query.includes("evadu")) {
            response = "<b>Carry Nest</b> was founded by a dedicated team in <b>Durki</b>. Our goal is to bring the latest fashion to our local community at the best prices.";
        } 
        else if (query.includes("order") || query.includes("buy") || query.includes("how to")) {
            response = "Ordering is easy! <br>1. Choose your favorite product.<br>2. Select your size.<br>3. Click 'Buy Now'.<br>4. Fill your details and confirm. We'll handle the rest!";
        }
        else if (query.includes("cancel")) {
            response = "<b>How to Cancel:</b><br>1. Go to 'Account' section.<br>2. Click on 'My Orders'.<br>3. Enter your phone number and find your order.<br>4. Click on the order and select 'Cancel Order' (Only available if status is NEW/CONFIRMED).";
        }
        else if (query.includes("exchange")) {
            response = "<b>How to Exchange:</b><br>1. Go to 'My Orders' in your account.<br>2. Open your delivered order.<br>3. Click 'Exchange' button.<br>4. Select your new desired size and confirm. (Available for 24 hours after delivery).";
        }
        else if (query.includes("return")) {
            response = "<b>How to Return:</b><br>1. Open your order in 'My Orders'.<br>2. If delivered, you will see a 'Return' button.<br>3. Select the reason for return and submit. (Available for 24 hours after delivery).";
        }
        else if (query.includes("delivery") || query.includes("time") || query.includes("eppudu")) {
            response = "For Durki (503301), we deliver within <b>2 to 4 days</b>! For other areas, please contact support.";
        }
        else if (query.includes("cod") || query.includes("cash") || query.includes("payment")) {
            response = "Yes, we support <b>Cash on Delivery (COD)</b>! You can pay when you receive your order.";
        }
        else if (query.includes("website") || query.includes("details")) {
            response = "Carry Nest is your local online fashion store. We focus on quality, speed, and trust. Our website is designed to give you a seamless shopping experience.";
        }
        else if (query.includes("hi") || query.includes("hello") || query.includes("namaste")) {
            response = "Namaste! Welcome to Carry Nest. I am your assistant. How can I help you today?";
        }
        else {
            response = "I'm sorry, I didn't quite get that. You can ask me about:<br>‚Ä¢ Who is the <b>Founder</b>?<br>‚Ä¢ <b>How to Order</b>?<br>‚Ä¢ <b>How to Cancel</b>?<br>‚Ä¢ <b>How to Exchange/Return</b>?";
        }

        document.getElementById(tempId).innerHTML = response;
        logs.scrollTop = logs.scrollHeight;
    }, 600);
}
</script>

</body>
</html>
